<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta http-equiv=accept-ch content="DPR, Viewport-Width, Width"><link rel=icon href=/favicon/favicon.ico type=image/gif><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><script async src="https://www.googletagmanager.com/gtag/js?id=G-6Z99Z4T0L0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6Z99Z4T0L0",{anonymize_ip:!1})}</script><meta property="og:title" content="Building a Match Crawler"><meta property="og:description" content="Journey to build a robust Match Crawler"><meta property="og:type" content="article"><meta property="og:url" content="https://jooncode.com/code/crawler/"><meta property="article:section" content="code"><meta property="article:published_time" content="2023-08-20T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-20T00:00:00+00:00"><meta property="og:site_name" content="Joon Career"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building a Match Crawler"><meta name=twitter:description content="Journey to build a robust Match Crawler"><link rel=stylesheet href=/bootstrap-5/css/bootstrap.min.css media=all><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--background-color:#eaedf0;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--background-color-dark:#18191a;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{font-size:1rem;font-weight:400;line-height:1.5;text-align:left}html{background-color:var(--background-color)!important}body::-webkit-scrollbar{width:.5em;height:.5em;background-color:var(--background-color)}::-webkit-scrollbar-track{box-shadow:inset 0 0 6px var(--background-color);border-radius:1rem}::-webkit-scrollbar-thumb{border-radius:1rem;background-color:var(--secondary-color);outline:1px solid var(--background-color)}#search-content::-webkit-scrollbar{width:.5em;height:.1em;background-color:var(--background-color)}</style><meta name=description content="Journey to build a robust Match Crawler"><link rel=stylesheet href=/css/single.css><script defer src=/fontawesome-5/all-5.15.4.js></script><title>Building a Match Crawler | Joon Career</title></head><body class=light><script>let localStorageValue=localStorage.getItem("pref-theme"),mediaQuery=window.matchMedia("(prefers-color-scheme: dark)").matches;switch(localStorageValue){case"dark":document.body.classList.add("dark");break;case"light":document.body.classList.remove("dark");break;default:mediaQuery&&document.body.classList.add("dark");break}</script><header><nav class="pt-3 navbar navbar-expand-lg animate"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/favicon/favicon.ico width=30 height=30 class="d-inline-block align-top">
00N</a><div><input id=search autocomplete=off class="form-control mr-sm-2 d-none d-md-block" placeholder='Ctrl + k to Search...' aria-label=Search oninput=searchOnChange(event)></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text d-block d-md-none"><div class=nav-link><input id=search autocomplete=off class="form-control mr-sm-2" placeholder='Ctrl + k to Search...' aria-label=Search oninput=searchOnChange(event)></div></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About Me</a></li><li class="nav-item navbar-text"><a class=nav-link href=/blogs title=interests>Interests</a></li><li class="nav-item navbar-text"><a class=nav-link href=/code title=code>Code</a></li><li class="nav-item navbar-text"><div class=text-center><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></li></ul></div></div></nav></header><div id=content><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><div class="title mb-5"><h1 class="text-center mb-4">Building a Match Crawler</h1><div class=text-center>HwiJoon Lee
<small>|</small>
Aug 20, 2023
<span id=readingTime>min read</span></div></div><div class=featured-image><img class=img-fluid src=/posts/League/valorant.jpeg alt="Building a Match Crawler"></div><article class="page-content p-2"><h2 id=introduction>Introduction</h2><p>Before I check my insights of Valorant with stats, the foremost task was to construct a robust data crawler. This pivotal first step would act as the foundation, paving the way for any meaningful analysis. When building a data crawler to fetch, process, and store a massive amount of data, challenges are inevitable. As I embarked on my journey to create a crawler for Valorant&rsquo;s match data, I encountered a series of obstacles that pushed me to optimize my approach in terms of speed, storage, and robustness.</p><p><img src=/posts/Valorant/image.png alt=image.png></p><h2 id=maximize-crawler-speed>Maximize Crawler Speed</h2><p>A critical limitation with Riot games data crawling is often the rate to retrieve data from their server. I had to maximize what I could get from the low API limit for demo product if I wanted to gather vast amounts of data. My initial solution was straightforward: send a request, get data, process, and repeat. However, this sequential approach wasn&rsquo;t cutting it.</p><h3 id=concurrent-api-requests-with-aiohttp>Concurrent API Requests with Aiohttp</h3><p>By using <strong><code>aiohttp</code></strong> , asynchronous HTTP client/server framework, I was able to send multiple requests concurrently. This approach was similar to having multiple data crawlers working simultaneously to call match info API. This dramatically increased the amount of data I could retrieve within my request limits. I was able to confirm it when I was receiving ‘429 error’, which means I was hitting maximum number of requests.</p><p><img src=/posts/Valorant/429.png alt=429.png></p><h2 id=oversized-documents>Oversized Documents</h2><p>Upon fetching the data, I noticed an immediate storage issue. The raw data I initially saved to MongoDB consumed a staggering 200KB-300KB per document. The voluminous nature of Valorant&rsquo;s API output with nested DTOs detailing every individual round, wasn&rsquo;t storage-friendly. Persisting with this raw format threatened to exhaust the storage capacity of our AWS machine. This was especially concerning as my crawls encompassed hundreds of matches in each loop. I tried to gzip the code to compress the data, but the zip was not very efficient because it was not recognizing repetitive patterns at the complicated API output to reduce the size.</p><h3 id=trimming-and-extraction>Trimming and Extraction</h3><p>I took a methodical approach, scouring the data to pinpoint areas ripe for trimming while ensuring the quality and integrity of our information remained untouched. Unused details were discarded, while critical stats underwent extraction and condensation. My efforts culminated in a drastically trimmed document size around 12KB.</p><p><img src=/posts/Valorant/size.png alt=collection></p><h3 id=code>Code</h3><p>Let’s delve into how I managed this feat in the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>extract_player_stats</span>(players, round_results):
</span></span><span style=display:flex><span>   <span style=color:#75715e>#Extract and clean player stats from provided data.</span>
</span></span><span style=display:flex><span>    damage_dict <span style=color:#f92672>=</span> {player[<span style=color:#e6db74>&#34;puuid&#34;</span>]: [] <span style=color:#66d9ef>for</span> player <span style=color:#f92672>in</span> players}
</span></span><span style=display:flex><span>    economy_dict <span style=color:#f92672>=</span> {player[<span style=color:#e6db74>&#34;puuid&#34;</span>]: [] <span style=color:#66d9ef>for</span> player <span style=color:#f92672>in</span> players}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> round_result <span style=color:#f92672>in</span> round_results:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> player_stat <span style=color:#f92672>in</span> round_result[<span style=color:#e6db74>&#34;playerStats&#34;</span>]:
</span></span><span style=display:flex><span>            stat_puuid <span style=color:#f92672>=</span> player_stat[<span style=color:#e6db74>&#34;puuid&#34;</span>]
</span></span><span style=display:flex><span>            <span style=color:#75715e># List comprehension to simplify the damage_dtos.</span>
</span></span><span style=display:flex><span>            damage_dict[stat_puuid]<span style=color:#f92672>.</span>append([
</span></span><span style=display:flex><span>                {k: v <span style=color:#66d9ef>for</span> k, v <span style=color:#f92672>in</span> dto<span style=color:#f92672>.</span>items() <span style=color:#66d9ef>if</span> k <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;receiver&#39;</span>} 
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> dto <span style=color:#f92672>in</span> player_stat[<span style=color:#e6db74>&#34;damage&#34;</span>]])
</span></span><span style=display:flex><span>            economy_dict[stat_puuid]<span style=color:#f92672>.</span>append(player_stat[<span style=color:#e6db74>&#34;economy&#34;</span>])
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e># Add the extracted data for the player</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> player <span style=color:#f92672>in</span> players:
</span></span><span style=display:flex><span>        puuid <span style=color:#f92672>=</span> player[<span style=color:#e6db74>&#34;puuid&#34;</span>]
</span></span><span style=display:flex><span>        player[<span style=color:#e6db74>&#34;totalDamageStat&#34;</span>] <span style=color:#f92672>=</span> condense_damage_list(damage_dict[puuid])
</span></span><span style=display:flex><span>        player[<span style=color:#e6db74>&#34;pistolRoundEconomy&#34;</span>] <span style=color:#f92672>=</span> get_pistol_round_economy(economy_dict[puuid])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> player[<span style=color:#e6db74>&#34;playerCard&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> player[<span style=color:#e6db74>&#34;playerTitle&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> player[<span style=color:#e6db74>&#34;partyId&#34;</span>]      
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> players
</span></span></code></pre></div><p>I crafted the <strong><code>extract_player_stats</code></strong> function with a clear focus—efficiently distill player statistics from the given data. Here&rsquo;s what went on inside:</p><p>A damage dictionary (<strong><code>damage_dict</code></strong>) and an economy dictionary (<strong><code>economy_dict</code></strong>) were initialized for each player.</p><p>Round by round, I saved the respective player&rsquo;s economic standing and damage records while removing unnecessary IDs.</p><p>Unnecessary player attributes such as <strong><code>playerCard</code></strong>, <strong><code>playerTitle</code></strong>, and <strong><code>partyId</code></strong> were removed, considering they don’t have any subsequent statistical usage.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>condense_damage_list</span>(rounds_damages) <span style=color:#f92672>-&gt;</span> list:
</span></span><span style=display:flex><span>    total_damage <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    leg_shots <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    body_shots <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    head_shots <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> round_damages <span style=color:#f92672>in</span> rounds_damages:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (len(round_damages) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> damage <span style=color:#f92672>in</span> round_damages:
</span></span><span style=display:flex><span>                total_damage <span style=color:#f92672>+=</span> damage[<span style=color:#e6db74>&#34;damage&#34;</span>]
</span></span><span style=display:flex><span>                leg_shots <span style=color:#f92672>+=</span> damage[<span style=color:#e6db74>&#34;legshots&#34;</span>]
</span></span><span style=display:flex><span>                body_shots <span style=color:#f92672>+=</span> damage[<span style=color:#e6db74>&#34;bodyshots&#34;</span>]
</span></span><span style=display:flex><span>                head_shots <span style=color:#f92672>+=</span> damage[<span style=color:#e6db74>&#34;headshots&#34;</span>]
</span></span><span style=display:flex><span>    output <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;damage&#34;</span>: total_damage,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;headshots&#34;</span>: head_shots,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;bodyshots&#34;</span>: body_shots,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;legshots&#34;</span>: leg_shots
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> output
</span></span></code></pre></div><p>The <strong><code>condense_damage_list</code></strong> function extracted all damges in each round into one dense damage detail of all round damages for each player.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_pistol_round_economy</span>(player_economy: list) <span style=color:#f92672>-&gt;</span> list:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        output <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        first_pistol_round <span style=color:#f92672>=</span> player_economy[FIRST_PISTOL_ROUND]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(first_pistol_round[<span style=color:#e6db74>&#34;spent&#34;</span>] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>            output<span style=color:#f92672>.</span>append(first_pistol_round)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        second_pistol_round <span style=color:#f92672>=</span> player_economy[SECOND_PISTOL_ROUND]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(second_pistol_round[<span style=color:#e6db74>&#34;spent&#34;</span>] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>            output<span style=color:#f92672>.</span>append(second_pistol_round)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> output
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>IndexError</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> output
</span></span></code></pre></div><p>Initially, I was planning to analyze pistol round purchases to find, which pistol and skills are preferred in agents, which might help us to understand the agent’s play style and their signature skill. So, I used the <strong><code>get_pistol_round_economy</code></strong> function to specifically extract this and reduce the size of the saved data.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>clean_round_result</span>(round_results):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> round_result <span style=color:#f92672>in</span> round_results:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> key <span style=color:#f92672>in</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;plantPlayerLocations&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;plantLocation&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;defusePlayerLocations&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;defuseLocation&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;bombPlanter&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;bombDefuser&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;playerStats&#34;</span>]:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>del</span> round_result[key]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> round_results
</span></span></code></pre></div><p>The <strong><code>clean_round_result</code></strong> function took center stage here. It looped across all round results, discarding chunks of extraneous data, including <strong><code>plantPlayerLocations</code></strong>, <strong><code>plantLocation</code></strong>, and a slew of other keys.</p><p>Through the integration of these refined functions, particularly within the <strong><code>save_match_info_to_db</code></strong> process, I achieved a MongoDB document that was not only lightweight but also condensed analysis-ready information.</p><h2 id=error-handling>Error Handling</h2><p>Even with optimized data fetching and storage, a crawler still had issues. During my testing phases, I encountered various API fails due- rate limits, temporary server issues, and unexpected response formats.</p><p><img src=/posts/Valorant/crawler.png alt=crawler></p><h3 id=comprehensive-error-handling>Comprehensive error handling</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>aiohttp_save_match_info_to_db</span>(session, match_id, retry_num<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>    url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;https://kr.api.riotgames.com/val/match/v1/matches/</span><span style=color:#e6db74>{</span>match_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> session<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>request_header) <span style=color:#66d9ef>as</span> response:   
</span></span><span style=display:flex><span>            status <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>status
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># ok response</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> status <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                content <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span>(content[<span style=color:#e6db74>&#34;matchInfo&#34;</span>][<span style=color:#e6db74>&#34;isCompleted&#34;</span>]):
</span></span><span style=display:flex><span>                    save_match_info_to_db(content)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> status
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Handle Rate limit exceeded</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>elif</span> status <span style=color:#f92672>==</span> <span style=color:#ae81ff>429</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>sleep(int(response<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#39;Retry-After&#39;</span>]))
</span></span><span style=display:flex><span>                retry_num <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> aiohttp_save_match_info_to_db(session, match_id, retry_num)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Riot Service error</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>elif</span> status <span style=color:#f92672>==</span> <span style=color:#ae81ff>503</span>:
</span></span><span style=display:flex><span>                retry_num <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> aiohttp_save_match_info_to_db(session, match_id, retry_num)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>elif</span> retry_num <span style=color:#f92672>==</span> RETRY_LIMIT:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#39;Retry limit exceeded&#39;</span>, response<span style=color:#f92672>.</span>status_code, response<span style=color:#f92672>.</span>headers)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>Exception</span>(<span style=color:#e6db74>&#34;Retry limit exceeded&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#39;Unhandled error&#39;</span>, response<span style=color:#f92672>.</span>status_code, response<span style=color:#f92672>.</span>headers)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>Exception</span>(response<span style=color:#f92672>.</span>status_code)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># This handles unknown server error by simply just retrying it.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> aiohttp<span style=color:#f92672>.</span>ClientOSError:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Aiohttp server Error with </span><span style=color:#e6db74>{</span>match_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        retry_num <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> aiohttp_save_match_info_to_db(session, match_id, retry_num)
</span></span></code></pre></div><p>Instead of allowing these errors to halt my crawler, I implemented mechanisms to detect and handle them accordingly. From waiting out a rate limit with <strong><code>asyncio.sleep()</code></strong> to retrying requests in the face of server errors, my crawler became resilient. Each error-handling iteration made the system more robust, ensuring continuous data retrieval despite temporary setbacks if I have encountered them before.</p><h2 id=improvements>Improvements</h2><p><img src=/posts/Valorant/MongoDB.png alt=MongoDB></p><p>By harnessing the power of asynchronous programming, fine-tuning data storage methods, and implementing robust error-handling mechanisms, I was able to optimize my data crawler. After reading API documentation multiple times, I was able to identify and extract the precise data I needed. This journey reminded me about the importance of perseverance, adaptability, and innovation in the face of technological hurdles. As developers, it&rsquo;s these trials that hone my skills, pushing me not just to build, but to build better.</p><p><img src=/posts/Valorant/kafka.jpg alt=MongoDB></p><p>Upon completing the website backend support using NestJS with mocked data for front end developers, our team&rsquo;s next goal is to enhance the efficiency and reliability of the crawler system. To achieve this, we intend to integrate with Kafka, which will effectively compartmentalize the crawler and statistical calculation components. This design choice ensures that the infrastructure remains robust and resistant to potential failures in the AWS machines.</p><p><img src=/posts/Valorant/MongoStruct.png alt=MongoDB></p><p>To further refine our statistical calculation mechanism, we plan to establish a separate observer database. This database will utilize the match ID as its MongoDB ID, with &ldquo;calculations&rdquo; as keys. The associated values, represented as booleans, will indicate whether the particular calculation has been completed or not. If the observer database value for a specific match ID is set to &ldquo;false&rdquo;, our stats calculations module will process the corresponding data.</p><p>This modular approach not only enables concurrent data processing but also adds an extra layer of reliability. Even if one of our AWS machines responsible for calculations encounters a failure, the overall process will continue uninterrupted.</p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#maximize-crawler-speed>Maximize Crawler Speed</a><ul><li><a href=#concurrent-api-requests-with-aiohttp>Concurrent API Requests with Aiohttp</a></li></ul></li><li><a href=#oversized-documents>Oversized Documents</a><ul><li><a href=#trimming-and-extraction>Trimming and Extraction</a></li><li><a href=#code>Code</a></li></ul></li><li><a href=#error-handling>Error Handling</a><ul><li><a href=#comprehensive-error-handling>Comprehensive error handling</a></li></ul></li><li><a href=#improvements>Improvements</a></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://jooncode.com/tags/valorant target=_blank>Valorant</a></li><li class=list-inline-item><a href=https://jooncode.com/tags/python target=_blank>Python</a></li><li class=list-inline-item><a href=https://jooncode.com/tags/mongodb target=_blank>MongoDB</a></li></ul></aside><aside class=social><h5>Social</h5><div class=social-content><ul class=list-inline><li class="list-inline-item text-center"><a target=_blank href="https://twitter.com/share?text=Building%20a%20Match%20Crawler&url=https%3a%2f%2fjooncode.com%2fcode%2fcrawler%2f"><i class="fab fa-twitter"></i></a></li><li class="list-inline-item text-center"><a target=_blank href="https://api.whatsapp.com/send?text=Building%20a%20Match%20Crawler: https%3a%2f%2fjooncode.com%2fcode%2fcrawler%2f"><i class="fab fa-whatsapp"></i></a></li><li class="list-inline-item text-center"><a target=_blank href='mailto:?subject=Building%20a%20Match%20Crawler&amp;body=Check%20out%20this%20site https%3a%2f%2fjooncode.com%2fcode%2fcrawler%2f'><i class="fa fa-envelope"></i></a></li></ul></div></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><div class=progress><div id=scroll-progress-bar class=progress-bar role=progressbar aria-valuenow=0 aria-valuemin=0 aria-valuemax=100></div></div><script src=/js/scrollProgressBar.js></script>
<script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><script src=/js/readingTime.js></script></div><footer><div class="container py-3" id=recent-posts><div class="h3 text-center text-secondary py-3">Recent Posts</div><div class="row justify-content-center"><div class="col-lg-4 col-md-6 pt-2"><div class="card h-100"><div class=card-header><a href=/code/mainpage/><img src=/posts/Valorant/mainPage.jpeg class=card-img-top alt="Crafting the Main Page"></a></div><div class="card-body bg-transparent p-3 shadow-sm"><a href=/code/mainpage/ class="primary-font card-title"><h5 class="card-title bg-transparent" title="Crafting the Main Page">Crafting the Main Page</h5></a><div class="card-text secondary-font"><p>Understanding Valorant Valorant&rsquo;s unique appeal is rooted in its foundational design philosophy that promotes a layered gaming experience. Players are incentivized when they successfully gather information, strategize their moves, and execute these strategies. This progression is termed the …</p></div></div><div class="mt-auto card-footer"><span class=float-start>Aug 25, 2023</span>
<a href=/code/mainpage/ class="float-end btn btn-outline-info btn-sm">Read</a></div></div></div><div class="col-lg-4 col-md-6 pt-2"><div class="card h-100"><div class=card-header><a href=/code/introduction/><img src=/posts/League/meAtRiot.jpeg class=card-img-top alt="Valorant Website Project"></a></div><div class="card-body bg-transparent p-3 shadow-sm"><a href=/code/introduction/ class="primary-font card-title"><h5 class="card-title bg-transparent" title="Valorant Website Project">Valorant Website Project</h5></a><div class="card-text secondary-font"><p>My Experience with Riot For the past 10 years, Riot Games has been the cornerstone of my gaming experience. I&rsquo;ve always cherished those competitive moments, playing alongside friends to clutch those hard-earned victories in League of Legends and Valorant.
My enthusiasm was so contagious that I …</p></div></div><div class="mt-auto card-footer"><span class=float-start>Aug 25, 2023</span>
<a href=/code/introduction/ class="float-end btn btn-outline-info btn-sm">Read</a></div></div></div><div class="col-lg-4 col-md-6 pt-2"><div class="card h-100"><div class=card-header><a href=/code/crawler/><img src=/posts/League/valorant.jpeg class=card-img-top alt="Building a Match Crawler"></a></div><div class="card-body bg-transparent p-3 shadow-sm"><a href=/code/crawler/ class="primary-font card-title"><h5 class="card-title bg-transparent" title="Building a Match Crawler">Building a Match Crawler</h5></a><div class="card-text secondary-font"><p>Introduction Before I check my insights of Valorant with stats, the foremost task was to construct a robust data crawler. This pivotal first step would act as the foundation, paving the way for any meaningful analysis. When building a data crawler to fetch, process, and store a massive amount of …</p></div></div><div class="mt-auto card-footer"><span class=float-start>Aug 20, 2023</span>
<a href=/code/crawler/ class="float-end btn btn-outline-info btn-sm">Read</a></div></div></div></div></div><div class="text-center pt-2"></div><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center"><div class=pb-2><a href=https://jooncode.com title="Joon Career"><img alt="Footer logo" src=/favicon/favicon.ico height=40px width=40px></a></div>&copy; 2023 All rights reserved<div class=text-secondary></div></div></div></div></footer><script src=/bootstrap-5/js/bootstrap.bundle.min.js></script>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))});var tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')),tooltipList=tooltipTriggerList.map(function(e){return new bootstrap.Tooltip(e)})</script><script src=/js/search.js></script>
<script src=/js/contact.js></script><section id=search-content class=py-2><div class=container id=search-results></div></section></body></html>